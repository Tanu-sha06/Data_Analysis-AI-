<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Data Analysis Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 1300px; margin: 30px auto; }
        .card { border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background-color: #e3f2fd;
            transition: all 0.3s;
        }
        .upload-area:hover { background-color: #bbdefb; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .kpi-card { text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; }
        .kpi-value { font-size: 2.8rem; font-weight: bold; }
        .table-container { max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-5 display-4">Universal Data Analysis Dashboard</h1>

        <!-- File Upload -->
        <div class="card">
            <div class="card-body">
                <div class="upload-area">
                    <h3>Drop your CSV file here or click to upload</h3>
                    <p class="text-muted">Works with any CSV: sales, logs, expenses, health, etc.</p>
                    <input type="file" id="csvFile" accept=".csv" class="form-control mt-3" style="display:none;">
                    <button class="btn btn-primary btn-lg mt-3" onclick="document.getElementById('csvFile').click();">
                        Choose CSV File
                    </button>
                    <p id="fileName" class="mt-3 fw-bold text-primary"></p>
                </div>
            </div>
        </div>

        <!-- Dashboard Content (hidden until file uploaded) -->
        <div id="dashboard" style="display:none;">
            <!-- KPIs -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="kpi-card">
                        <h5>Total Rows</h5>
                        <div class="kpi-value" id="totalRows">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <h5>Numeric Columns</h5>
                        <div class="kpi-value" id="numCols">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <h5>Total Sum (First Num Col)</h5>
                        <div class="kpi-value" id="totalSum">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <h5>Average (First Num Col)</h5>
                        <div class="kpi-value" id="avgValue">0</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Trend Over Time (if date detected)</h5>
                            <div class="chart-container">
                                <canvas id="lineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Top Categories (First Text Column)</h5>
                            <div class="chart-container">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table Preview -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Data Preview (First 20 rows)</h5>
                    <div class="table-container">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead class="table-dark" id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lineChart, barChart;
        let rawData = [];

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = `Loaded: ${file.name}`;
            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                rawData = parseCSV(csv);
                updateDashboard(rawData);
                document.getElementById('dashboard').style.display = 'block';
            };
            reader.readAsText(file);
        });

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => row[h] = values[idx]);
                    data.push(row);
                }
            }
            return { headers, data };
        }

        function updateDashboard({ headers, data }) {
            // KPIs
            document.getElementById('totalRows').textContent = data.length;

            // Find first numeric column
            let firstNumCol = null;
            let sum = 0, count = 0;
            headers.forEach(h => {
                const nums = data.map(row => parseFloat(row[h])).filter(n => !isNaN(n));
                if (nums.length > 0 && !firstNumCol) {
                    firstNumCol = h;
                    sum = nums.reduce((a,b) => a+b, 0);
                    count = nums.length;
                }
            });
            document.getElementById('numCols').textContent = headers.filter(h => {
                return data.some(row => !isNaN(parseFloat(row[h])));
            }).length;
            document.getElementById('totalSum').textContent = sum.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('avgValue').textContent = count > 0 ? (sum/count).toFixed(2) : 'N/A';

            // Line Chart: Try to find date column + numeric
            let dateCol = headers.find(h => h.toLowerCase().includes('date') || h.toLowerCase().includes('time'));
            let valueCol = firstNumCol;

            if (dateCol && valueCol) {
                const sortedData = data
                    .map(row => ({ date: new Date(row[dateCol]), value: parseFloat(row[valueCol]) }))
                    .filter(d => !isNaN(d.value) && d.date instanceof Date && !isNaN(d.date))
                    .sort((a,b) => a.date - b.date);

                const labels = sortedData.map(d => d.date.toLocaleDateString());
                const values = sortedData.map(d => d.value);

                if (lineChart) lineChart.destroy();
                const ctx = document.getElementById('lineChart').getContext('2d');
                lineChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: valueCol, data: values, borderColor: '#007bff', fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Bar Chart: Top values in first non-date text column
            let categoryCol = headers.find(h => h.toLowerCase().includes('category') || h.toLowerCase().includes('product') || h.toLowerCase().includes('name'));
            if (!categoryCol) categoryCol = headers.find(h => isNaN(parseFloat(data[0][h])) && h !== dateCol);

            if (categoryCol && valueCol) {
                const agg = {};
                data.forEach(row => {
                    const cat = row[categoryCol] || 'Unknown';
                    const val = parseFloat(row[valueCol]) || 0;
                    agg[cat] = (agg[cat] || 0) + val;
                });
                const sorted = Object.entries(agg).sort((a,b) => b[1] - a[1]).slice(0, 10);
                const labels = sorted.map(x => x[0]);
                const values = sorted.map(x => x[1]);

                if (barChart) barChart.destroy();
                const ctx2 = document.getElementById('barChart').getContext('2d');
                barChart = new Chart(ctx2, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: categoryCol, data: values, backgroundColor: '#28a745' }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Table Preview
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            tbody.innerHTML = '';
            data.slice(0, 20).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = row[h];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>